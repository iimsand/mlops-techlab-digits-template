<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Puzzle MLOps Lab</title>
</head>
<script type="application/ecmascript">
    const width = 300;
    const height = 300;
    const color = '#333';
    const lineWidth = 20;
    const background = 'white';
    const maxCanvasWidth = 300;
    const backendUrl = 'http://localhost:8888/predict';
    const textNotEvaluated = 'noch nicht ausgewertet'

    let isDrawing = false;
    let start = { x: 0, y: 0 };

    let canvasTop = 0;
    let canvasLeft = 0;

    let canvasWidth = 300;

    let canvas;
    let context;

    const handleStart = (({ offsetX: x, offsetY: y }) => {
        if (color === background) {
            context.clearRect(0, 0, width, height)
        } else {
            isDrawing = true
            start = { x, y }
            context.beginPath()
            context.moveTo(x, y)
        }
    })

    const handleEnd = () => {
        isDrawing = false;
        context.closePath();
    }
    const handleMove = (({ offsetX: x1, offsetY: y1 }) => {
        if (!isDrawing) return

        context.lineTo(x1, y1)

        context.stroke()

        start = { x: x1, y: y1 }
    })

    const handleSize = () => {
        const { top, left } = canvas.getBoundingClientRect()
        topCanvas = top
        leftCanvas = left
    }

    const predict = async () => {
        const image = await createImageBitmap(canvas, { resizeWidth: 8, resizeHeight: 8, resizeQuality: "high" });
        const simplifiedContext = document.getElementById("simplified").getContext("2d");
        simplifiedContext.drawImage(image, 0, 0);
        const imageData = simplifiedContext.getImageData(0, 0, 8, 8).data;
        const grayArray = [];
        for (let i = 0; i < imageData.length; i += 4) {
            const red = imageData[i];
            const green = imageData[i + 1];
            const blue = imageData[i + 2];

            const gray = Math.round((red + green + blue)/255*16);
            grayArray.push(gray);
        }
        const response = await fetch(
            backendUrl, {
                mode: "cors",
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({data: [grayArray]})
            }
        )
        if (response.ok) {
            document.getElementById("result").innerText = (await response.json());
        } else {
            document.getElementById("result").innerText = "Entschlüsselung des Rätsels wegen technischen Problemen nicht möglich...";
        }
    }

    const clearContent = () => {
        document.getElementById("result").innerText = textNotEvaluated;
        context.clearRect(0, 0, width, height);
        document.getElementById("simplified").getContext("2d").clearRect(0, 0, width, height);
    }

    window.onload = () => {
        document.getElementById("result").innerText = textNotEvaluated;

        canvas = document.getElementById("canvas");
        canvas.width = width;
        canvas.height = height;
        canvas.background = background;

        context = canvas.getContext("2d");
        context.lineWidth = lineWidth;
        context.lineCap = "round"
        context.strokeStyle = color;
        handleSize();

        canvas.addEventListener("mousedown", handleStart);
        canvas.addEventListener("touchstart", e => {
            const { clientX, clientY } = e.touches[0]
            handleStart({
                offsetX: clientX - canvasLeft,
                offsetY: clientY - canvasTop
            });
        });
        canvas.addEventListener("mouseup", handleEnd);
        canvas.addEventListener("touchend", handleEnd)
        canvas.addEventListener("mouseleave", handleEnd);
        canvas.addEventListener("mousemove", handleMove);
        canvas.addEventListener("touchmove", e => {
            const { clientX, clientY } = e.touches[0]
            console.log(e.touches)
            handleMove({
                offsetX: clientX - canvasLeft,
                offsetY: clientY - canvasTop
            });
        });
        window.addEventListener("resize", handleSize);

    }



</script>
<style>
    #canvas {
        width: 300px;
        height: 300px;
        min-height: 300px;
        min-width: 300px;
        max-width: 300px;
        max-height: 300px;
    }
    button {
        width: 300px;
        height: 50px;
        font-size: 36px;
        margin: auto;
    }
    #result {
        font-size: 24px;
    }
</style>

<body style="display: flex; flex-direction: column; max-width: 700px; margin: 2em; text-align: center;">
    <h1>Puzzle MLOps Lab</h1>
    <h2>Enträtsle deine Handschrift</h2>
    <div style="display: flex; justify-content: space-evenly;">
        <div>
            <canvas id="canvas" style="border: solid 5pt orange;width: 300px; height: 300px;" width="300" height="300"></canvas>
            <p>Zeichne eine einzelne Ziffer</p>
        </div>
        <div>
            <canvas id="simplified" style="border: solid 5pt orange;width: 300px; height: 300px;" width="8" height="8"></canvas>
            <p>Vorprozessiertes Bild</p>
        </div>
    </div>
    
    <button onclick="predict()">Enträtseln</button>
    <div>
        <h2>Resultat</h2>
        <p id="result"></p>
    </div>
    <button onclick="clearContent()">Alles löschen</button>
</body>

</html>
